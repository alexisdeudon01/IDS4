classDiagram
    direction LR
    class AgentSupervisor {
        -ConfigManager config_manager
        -multiprocessing.Manager manager
        -dict shared_state
        -multiprocessing.Event shutdown_event
        -list processes
        -dict process_map
        -DockerManager docker_manager
        -VectorManager vector_manager
        -SuricataManager suricata_manager
        -GitWorkflow git_workflow
        +__init__(config_path)
        +_start_child_process(name, target_class)
        +_monitor_processes()
        +_graceful_shutdown()
        +run()
    }

    class BaseComponent {
        #dict shared_state
        #ConfigManager config
        #multiprocessing.Event shutdown_event
        #logging.Logger logger
        +__init__(shared_state, config_manager, shutdown_event)
        +get_config(key, default)
        +update_shared_state(key, value)
        +log_error(message, exception)
        +is_shutdown_requested()
        +run()
    }

    class ConfigManager {
        -str config_path
        -dict config
        +__init__(config_path)
        +_load_config()
        +get(key, default)
        +reload_config()
    }

    class ResourceController {
        -float cpu_limit
        -float ram_limit
        -int sleep_interval
        +_get_system_metrics()
        +_apply_throttling(cpu_usage, ram_usage)
        +run()
    }

    class ConnectivityAsync {
        -str opensearch_endpoint
        -str aws_region
        -str redis_host
        -int redis_port
        -int max_retries
        -int initial_backoff
        -AWSManager aws_manager
        +_retry_operation(func, *args, **kwargs)
        +check_dns_resolution(hostname)
        +check_tls_handshake(hostname, port)
        +check_opensearch_bulk_test()
        +check_redis_connectivity()
        +run_connectivity_checks()
        +run()
    }

    class AWSManager {
        -str opensearch_endpoint
        -str aws_region
        -str aws_profile
        -str opensearch_domain_name
        -boto3.Session session
        -boto3.client boto3_opensearch_client
        -opensearchpy.OpenSearch _opensearch_client_instance
        +_get_aws_session()
        +_get_opensearch_client()
        +send_bulk_to_opensearch(logs, index_name_prefix, max_retries, initial_backoff)
        +provision_opensearch_domain(max_wait_time)
        +apply_index_template(template_name, index_pattern)
    }

    class DockerManager {
        -str docker_compose_path
        -docker.client client
        -list required_services
        +_check_docker_daemon()
        +_run_docker_compose_command(command, detach)
        +prepare_docker_stack()
        +stop_docker_stack()
        +check_stack_health()
    }

    class VectorManager {
        -str vector_config_path
        -str log_read_path
        -str opensearch_endpoint
        -str aws_region
        -str redis_host
        -int redis_port
        -str vector_disk_buffer_max_size
        -str vector_redis_buffer_max_size
        -str vector_opensearch_buffer_max_size
        -int vector_batch_max_events
        -int vector_batch_timeout_secs
        +generate_vector_config()
        +check_vector_health()
    }

    class SuricataManager {
        -str suricata_config_path
        -str log_output_path
        -str network_interface
        -dict eve_log_options
        -subprocess.Popen suricata_process
        +generate_suricata_config()
        +start_suricata()
        +stop_suricata()
        +restart_suricata()
        +run()
    }

    class MetricsServer {
        -int port
        -int update_interval
        -Gauge cpu_usage_gauge
        -Gauge ram_usage_gauge
        -Gauge redis_queue_depth_gauge
        -Gauge vector_health_gauge
        -Counter ingestion_rate_counter
        -Counter error_counter
        -Gauge aws_ready_gauge
        -Gauge redis_ready_gauge
        -Gauge pipeline_ok_gauge
        -Gauge throttling_level_gauge
        +_update_metrics()
        +run()
    }

    class GitWorkflow {
        -str target_branch
        +_run_git_command(command_args)
        +check_branch()
        +commit_and_push_changes(message)
    }

    class SuricataRulesManager {
        -str rules_path
        -str oinkcode
        -list rule_sources
        -int update_interval
        +_download_rules(url, destination_dir)
        +update_rules()
        +run()
    }

    class WebInterfaceManager {
        # (Contenu Ã  ajouter plus tard)
    }

    AgentSupervisor --> ConfigManager
    AgentSupervisor --> DockerManager
    AgentSupervisor --> VectorManager
    AgentSupervisor --> SuricataManager
    AgentSupervisor --> GitWorkflow
    AgentSupervisor --> ResourceController
    AgentSupervisor --> ConnectivityAsync
    AgentSupervisor --> MetricsServer
    AgentSupervisor --> SuricataRulesManager
    AgentSupervisor --> WebInterfaceManager

    ResourceController --|> BaseComponent
    ConnectivityAsync --|> BaseComponent
    AWSManager --|> BaseComponent
    DockerManager --|> BaseComponent
    VectorManager --|> BaseComponent
    SuricataManager --|> BaseComponent
    MetricsServer --|> BaseComponent
    GitWorkflow --|> BaseComponent
    SuricataRulesManager --|> BaseComponent
    WebInterfaceManager --|> BaseComponent

    ConnectivityAsync --> AWSManager
